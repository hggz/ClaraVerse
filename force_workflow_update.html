<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Workflow Update</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        button { padding: 12px 20px; margin: 10px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #005a87; }
        button.danger { background: #dc3545; }
        button.success { background: #28a745; }
        #output { background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap; margin: 20px 0; border-left: 4px solid #007cba; min-height: 100px; font-family: monospace; }
        .warning { background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin: 20px 0; }
        .success { background: #d4edda; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Force Workflow Update</h1>
        
        <div class="warning">
            <h3>âš ï¸ Important:</h3>
            <p>This tool will force update your basic_input workflow with the enhanced version. The sync button in ClaraVerse didn't work because of timestamp comparison. This bypasses that check.</p>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="checkCurrentWorkflow()" class="success">ğŸ“Š Check Current Workflow</button>
            <button onclick="forceUpdateWorkflow()" class="danger">ğŸ”„ Force Update to Enhanced Version</button>
            <button onclick="updateSyncDirectory()" style="background: #6f42c1;">ğŸ’¾ Update Sync Directory</button>
            <button onclick="clearLog()">ğŸ§¹ Clear Log</button>
        </div>

        <div id="output">Click "Check Current Workflow" to see the current state...</div>
    </div>

    <script>
        const DB_NAME = 'clara_db';
        const DB_VERSION = 8;
        const SYNC_DIR_KEY = 'clara_workflow_sync_directory';
        const WORKFLOW_ID = '1749181106265-6rs1e5uwq';

        // Enhanced workflow with current timestamp
        const enhancedWorkflow = {
            "id": "1749181106265-6rs1e5uwq",
            "name": "basic_input_modified",
            "nodes": [
                {
                    "id": "1749182007323-o5va4dlr0",
                    "type": "input",
                    "name": "Enhanced Input",
                    "position": {
                        "x": 45.40475384453009,
                        "y": 161.61581212001443
                    },
                    "data": {
                        "placeholder": "Enter your input here...",
                        "validation": true
                    },
                    "inputs": [],
                    "outputs": [
                        {
                            "id": "output",
                            "name": "Value",
                            "type": "output",
                            "dataType": "any",
                            "description": "Enhanced input value with validation"
                        }
                    ],
                    "metadata": {
                        "tags": ["input", "basic", "source", "enhanced"],
                        "documentation": "Enhanced input node with validation and placeholder support. Provides input values to start or feed the workflow."
                    }
                },
                {
                    "id": "new-validation-node",
                    "type": "validation",
                    "name": "Input Validator",
                    "position": {
                        "x": 300,
                        "y": 161
                    },
                    "data": {
                        "rules": {
                            "required": true,
                            "minLength": 1
                        }
                    },
                    "inputs": [
                        {
                            "id": "input",
                            "name": "Input",
                            "type": "input",
                            "dataType": "any"
                        }
                    ],
                    "outputs": [
                        {
                            "id": "valid",
                            "name": "Valid",
                            "type": "output",
                            "dataType": "any"
                        },
                        {
                            "id": "invalid",
                            "name": "Invalid",
                            "type": "output",
                            "dataType": "error"
                        }
                    ],
                    "metadata": {
                        "tags": ["validation", "quality"],
                        "documentation": "Validates input according to specified rules"
                    }
                }
            ],
            "connections": [
                {
                    "id": "connection-1",
                    "source": "1749182007323-o5va4dlr0",
                    "sourceOutput": "output",
                    "target": "new-validation-node",
                    "targetInput": "input"
                }
            ],
            "variables": [
                {
                    "id": "validation_enabled",
                    "name": "Enable Validation",
                    "type": "boolean",
                    "default": true
                }
            ],
            "settings": {
                "name": "basic_input_modified",
                "version": "1.1.0",
                "description": "Enhanced basic input workflow with validation"
            },
            "createdAt": "2025-06-06T03:46:04.523Z",
            "updatedAt": new Date().toISOString(), // Current timestamp
            "version": "1.1.0",
            "tags": ["input", "basic", "validation", "enhanced"]
        };

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('output').textContent = '';
        }

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function checkCurrentWorkflow() {
            clearLog();
            try {
                log('ğŸ” Checking current workflow state...');
                
                const db = await openDatabase();
                const transaction = db.transaction(['agent_workflows'], 'readonly');
                const store = transaction.objectStore('agent_workflows');
                
                const request = store.get(WORKFLOW_ID);
                request.onsuccess = function() {
                    const workflow = request.result;
                    if (workflow) {
                        log(`âœ… Found workflow: ${workflow.name}`);
                        log(`ğŸ“… Last updated: ${new Date(workflow.updatedAt).toLocaleString()}`);
                        log(`ğŸ”¢ Version: ${workflow.version || 'N/A'}`);
                        log(`ğŸ“Š Nodes: ${workflow.nodes ? workflow.nodes.length : 0}`);
                        log(`ğŸ”— Connections: ${workflow.connections ? workflow.connections.length : 0}`);
                        log(`ğŸ·ï¸ Tags: ${(workflow.tags || []).join(', ') || 'None'}`);
                        
                        if (workflow.nodes && workflow.nodes.length > 1) {
                            log('âœ… Workflow appears to be the enhanced version');
                        } else {
                            log('âš ï¸ Workflow appears to be the original version');
                        }
                        
                        log('\nğŸ“‹ Current workflow structure:');
                        log(JSON.stringify(workflow, null, 2));
                    } else {
                        log('âŒ Workflow not found!');
                    }
                };
                
                db.close();
                
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        async function forceUpdateWorkflow() {
            if (!confirm('This will replace your current basic_input workflow with the enhanced version. Continue?')) {
                return;
            }

            try {
                log('ğŸ”„ Force updating workflow...', 'success');
                
                const db = await openDatabase();
                const transaction = db.transaction(['agent_workflows'], 'readwrite');
                const store = transaction.objectStore('agent_workflows');
                
                // Force update with current timestamp
                const workflowToUpdate = { ...enhancedWorkflow };
                workflowToUpdate.updatedAt = new Date().toISOString();
                
                const request = store.put(workflowToUpdate);
                request.onsuccess = function() {
                    log('âœ… Workflow updated successfully!', 'success');
                    log(`ğŸ“… New timestamp: ${workflowToUpdate.updatedAt}`);
                    log(`ğŸ“ Name: ${workflowToUpdate.name}`);
                    log(`ğŸ”¢ Version: ${workflowToUpdate.version}`);
                    log(`ğŸ“Š Nodes: ${workflowToUpdate.nodes.length}`);
                    log(`ğŸ”— Connections: ${workflowToUpdate.connections.length}`);
                    
                    log('\nğŸ”„ Please refresh your ClaraVerse UI to see the changes!');
                    
                    // Also update sync directory
                    updateSyncDirectory();
                };
                
                request.onerror = function() {
                    log('âŒ Failed to update workflow', 'error');
                };
                
                db.close();
                
            } catch (error) {
                log(`âŒ Update error: ${error.message}`, 'error');
            }
        }

        function updateSyncDirectory() {
            try {
                log('ğŸ’¾ Updating sync directory...');
                
                const syncDir = JSON.parse(localStorage.getItem(SYNC_DIR_KEY) || '{}');
                
                const workflowToSync = { ...enhancedWorkflow };
                workflowToSync.updatedAt = new Date().toISOString();
                
                syncDir[WORKFLOW_ID] = {
                    name: workflowToSync.name,
                    lastSync: new Date().toISOString(),
                    workflow: workflowToSync
                };
                
                localStorage.setItem(SYNC_DIR_KEY, JSON.stringify(syncDir, null, 2));
                
                log('âœ… Sync directory updated!', 'success');
                log('ğŸ’¡ Now the sync button in ClaraVerse should work correctly');
                
            } catch (error) {
                log(`âŒ Sync directory error: ${error.message}`, 'error');
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            log('ğŸš€ Force Workflow Update Tool ready!');
            log('ğŸ’¡ This tool will help you update your workflow with the enhanced version');
            setTimeout(checkCurrentWorkflow, 1000);
        });
    </script>
</body>
</html>
